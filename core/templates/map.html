{% extends 'base.html' %}
{% block title %}Canlı Harita - Looopone{% endblock %}

{% block extra_css %}
<style>
    #map { height: 90vh; width: 100%; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); background-color: #f8f9fa; }
    .info-box { color: #333; padding: 5px; font-family: sans-serif; min-width: 150px; }
    .status-bar-bg { background: #eee; height: 10px; border-radius: 5px; width: 100%; margin: 5px 0; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div id="map"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlqqY_7xi8nLbXt-COj73W7KUwEpBr5Dg&callback=initMap" async defer></script>

<script>
    let map;
    let markers = []; 
    let directionsService;
    let directionsRenderer;

    function initMap() {
        // Harita objesini oluştur
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 38.3894, lng: 27.0461 },
            zoom: 13
        });
        
        // Rota servislerini başlat
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            suppressMarkers: true, 
            polylineOptions: { strokeColor: "#2563eb", strokeWeight: 5 }
        });
        
        directionsRenderer.setMap(map); 

        // Verileri çekmeye başla
        updateData();
        setInterval(updateData, 30000); 
    }

    function updateData() {
        fetch('/api/containers/', { cache: "no-store" })
            .then(response => response.json())
            .then(data => {
                // Eskileri temizle
                markers.forEach(m => m.setMap(null));
                markers = [];

                const bounds = new google.maps.LatLngBounds();

                data.forEach(container => {
                    const lat = parseFloat(container.lat);
                    const lng = parseFloat(container.lng);
                    if (isNaN(lat) || isNaN(lng)) return;
                    
                    let color = container.fill >= 80 ? "#ef4444" : (container.fill >= 50 ? "#f59e0b" : "#10b981");

                    const circle = new google.maps.Circle({
                        strokeColor: color,
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: color,
                        fillOpacity: 0.35,
                        map: map,
                        center: { lat: lat, lng: lng },
                        radius: 30
                    });

                    circle.addListener("click", () => {
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<strong>Konteyner #${container.id}</strong><br>Doluluk: %${container.fill}`
                        });
                        infoWindow.setPosition(circle.getCenter());
                        infoWindow.open(map);
                    });

                    markers.push(circle);
                    bounds.extend({ lat: lat, lng: lng });
                });

                // Rota çizimini tetikle
                drawRoute(data);
            })
            .catch(error => console.error("Veri hatası:", error));
    }

    function drawRoute(data) {
        // Şimdilik testi kolaylaştırmak için sınırı 10'a çektim
        const waypoints = data
            .filter(c => c.fill >= 0) 
            .map(c => ({
                location: new google.maps.LatLng(parseFloat(c.lat), parseFloat(c.lng)),
                stopover: true
            }));

        if (waypoints.length < 2) {
            directionsRenderer.setDirections({routes: []});
            return;
        }

        const origin = waypoints.shift().location;
        const destination = waypoints.pop().location;

        directionsService.route({
            origin: origin,
            destination: destination,
            waypoints: waypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING,
        }, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
            } else {
                console.error("Rota çizilemedi: " + status);
            }
        });
    }
</script>
{% endblock %}