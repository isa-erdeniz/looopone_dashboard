{% extends 'base.html' %}
{% block title %}Canlı Harita - Looopone{% endblock %}

{% block extra_css %}
<style>
    #map { height: 90vh; width: 100%; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); background-color: #f8f9fa; }
    .info-box { color: #333; padding: 5px; font-family: sans-serif; min-width: 150px; }
    .status-bar-bg { background: #eee; height: 10px; border-radius: 5px; width: 100%; margin: 5px 0; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div id="map"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlqqY_7xi8nLbXt-COj73W7KUwEpBr5Dg&callback=initMap" async defer></script>

<script>
    function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 38.3894, lng: 27.0461 },
            zoom: 13
        });

        // Haritayı tüm konteynerleri kapsayacak şekilde genişletmek için "bounds" objesi
        const bounds = new google.maps.LatLngBounds();

        fetch('/api/containers/', { cache: "no-store" })
            .then(response => response.json())
            .then(data => {
                console.log("Gelen Veriler:", data); // F12 Konsolunda verileri görebilirsin

                if (data.length === 0) {
                    console.log("Veritabanı boş, veri gelmedi.");
                    return;
                }

                data.forEach(container => {
                    // Sayıları zorla ondalık sayıya çeviriyoruz (Hata önleyici)
                    const lat = parseFloat(container.lat);
                    const lng = parseFloat(container.lng);

                    // Eğer koordinatlar geçerli bir sayı değilse bu konteyneri atla
                    if (isNaN(lat) || isNaN(lng)) return;

                    const color = container.fill > 80 ? "#ef4444" : "#10b981";
                    const position = { lat: lat, lng: lng };

                    const containerCircle = new google.maps.Circle({
                        strokeColor: color,
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: color,
                        fillOpacity: 0.4,
                        map: map,
                        center: position,
                        radius: 70 
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-box">
                                <strong>Konteyner #${container.id}</strong><br>
                                <small>${container.address || 'Rastgele Adres'}</small>
                                <div class="status-bar-bg">
                                    <div style="background:${color}; height:100%; width:${container.fill}%; border-radius:5px;"></div>
                                </div>
                                <span>Doluluk: %${container.fill}</span>
                            </div>`
                    });

                    containerCircle.addListener("click", () => {
                        infoWindow.setPosition(containerCircle.getCenter());
                        infoWindow.open(map);
                    });

                    // Harita sınırlarını bu konteynere göre genişlet
                    bounds.extend(position);
                });

                // Tüm konteynerler eklendikten sonra haritayı onlara odakla
                if (data.length > 0) {
                    map.fitBounds(bounds);
                }
            })
            .catch(error => console.error("Veri hatası:", error));
    }
</script>
{% endblock %}